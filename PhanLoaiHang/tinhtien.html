<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tính cước vận chuyển </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark-mode {
      background-color: #1a1a1a;
      color: #ffffff;
    }
    header {
      background: linear-gradient(to right, #673ab7, #9c27b0);
      color: white;
      padding: 20px;
      text-align: center;
    }
    nav {
      background-color: #333;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    nav a {
      margin: 6px;
      padding: 12px 16px;
      background: linear-gradient(to right, #3f51b5, #673ab7);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: transform 0.2s ease;
    }
    nav a:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    main {
      padding: 30px 20px;
      max-width: 900px;
      margin: auto;
    }
    .source-card {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 20px;
    }
    body.dark-mode .source-card {
      background-color: #333;
    }
    .source-card h2 {
      color: #ff5722;
      margin-bottom: 20px;
    }
    .source-card p.intro {
      font-size: 16px;
      color: #666;
      margin-bottom: 20px;
    }
    body.dark-mode .source-card p.intro {
      color: #bbb;
    }
    .source-card form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .source-card .address-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .source-card select, .source-card input[type="text"] {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      width: 200px;
    }
    body.dark-mode .source-card select, body.dark-mode .source-card input[type="text"] {
      background-color: #444;
      color: #ddd;
      border-color: #555;
    }
    .source-card button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s ease;
    }
    .source-card .btn-calculate {
      background-color: #2196f3;
      color: white;
    }
    .source-card .btn-calculate:hover {
      background-color: #0b7dda;
      transform: scale(1.05);
    }
    .source-card .btn-reset {
      background-color: #f44336;
      color: white;
    }
    .source-card .btn-reset:hover {
      background-color: #d32f2f;
      transform: scale(1.05);
    }
    #map {
      width: 100%;
      height: 300px;
      background-color: #eee;
      border-radius: 5px;
      margin-top: 20px;
    }
    body.dark-mode #map {
      background-color: #444;
    }
    #result {
      margin-top: 20px;
      font-size: 16px;
      color: #444;
    }
    body.dark-mode #result {
      color: #ddd;
    }
    .chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #ff5722;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1001;
    }
    .chat-options {
      position: fixed;
      bottom: 90px;
      right: 20px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    .chat-options a {
      background-color: #fff;
      color: #333;
      text-decoration: none;
      padding: 10px 15px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-size: 14px;
    }
    body.dark-mode .chat-options a {
      background-color: #333;
      color: #ddd;
    }
    footer {
      background-color: #222;
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: 40px;
    }
    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #ff5722;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        align-items: center;
      }
      nav a {
        width: 90%;
        text-align: center;
      }
      .source-card .address-group {
        flex-direction: column;
        align-items: stretch;
      }
      .source-card select, .source-card input[type="text"] {
        width: 100%;
      }
      #map {
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <button id="theme-toggle"><i class="fas fa-moon"></i></button>
  <header>
    <h1>Kho Miền Trung - Tính Cước Vận Chuyển</h1>
  </header>
  <nav>
    <a href="index.html"><i class="fas fa-home"></i> Trang chủ</a>
    <a href="nguonhang.html"><i class="fas fa-box"></i> Nguồn hàng</a>
    <a href="tracuu.html"><i class="fas fa-search"></i> Tra cứu</a>
    <a href="tinhtien.html"><i class="fas fa-calculator"></i> Tính tiền</a>
    <a href="lienhe.html"><i class="fas fa-envelope"></i> Liên hệ</a>
  </nav>
  <main>
    <div class="source-card">
      <h2>Tính cước vận chuyển</h2>
      <p class="intro">Tra cứu cước vận chuyển nhanh chóng và chính xác cho mọi đơn hàng trong khu vực Đà Nẵng. Vui lòng nhập thông tin để bắt đầu!</p>
      <form id="shipping-form">
        <h3>Gửi từ:*</h3>
        <p>Điểm nhận hàng: Hòa Khánh Nam, Liên Chiểu, Đà Nẵng (16.059212, 108.147189)</p>
        <h3>Gửi đến:*</h3>
        <div class="address-group">
          <input type="text" id="address" placeholder="Số nhà, đường" required>
          <input type="text" id="districtInput" placeholder="Quận/Huyện" list="districts" required oninput="filterWards()">
          <datalist id="districts">
            <option value="Liên Chiểu">
            <option value="Hải Châu">
            <option value="Sơn Trà">
            <option value="Ngũ Hành Sơn">
            <option value="Cẩm Lệ">
            <option value="Thanh Khê">
            <option value="Hòa Vang">
            <option value="Hoàng Sa">
          </datalist>
          <input type="text" id="wardInput" placeholder="Phường/Xã" list="wards" required>
          <datalist id="wards"></datalist>
        </div>
        <h3>Trọng lượng:*</h3>
        <input type="text" id="weight" placeholder="Nhập cân nặng (kg)" required>
        <button type="submit" class="btn-calculate">Tính cước</button>
        <button type="button" class="btn-reset" onclick="resetForm()">Làm mới</button>
      </form>
      <div id="map">Bản đồ (Placeholder - Sử dụng OpenStreetMap miễn phí)</div>
      <div id="result"></div>
    </div>
  </main>
  <button class="chat-toggle" onclick="toggleChatOptions()"><i class="fas fa-comment"></i></button>
  <div class="chat-options" id="chatOptions">
    <a href="https://www.facebook.com/quang.khoi.le.875150/" target="_blank">Liên hệ qua Facebook</a>
    <a href="tel:0328516027">Gọi trực tiếp: 0328 516 027</a>
  </div>
  <footer>
    © 2025 Hệ thống kho thông minh - Thiết kế bởi Khoi LQ
  </footer>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script>
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const icon = document.querySelector('#theme-toggle i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    });

    function toggleChatOptions() {
      const options = document.getElementById('chatOptions');
      options.style.display = options.style.display === 'flex' ? 'none' : 'flex';
    }

    function resetForm() {
      document.getElementById('shipping-form').reset();
      document.getElementById('wardInput').value = '';
      document.getElementById('wards').innerHTML = '';
      document.getElementById('map').innerHTML = 'Bản đồ (Placeholder - Sử dụng OpenStreetMap miễn phí)';
      document.getElementById('result').innerHTML = '';
      map.setView([16.059212, 108.147189], 12);
      pickupMarker.openPopup();
    }

    const map = L.map('map').setView([16.059212, 108.147189], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    const pickupMarker = L.marker([16.059212, 108.147189]).addTo(map)
      .bindPopup('Điểm nhận hàng: Hòa Khánh Nam, Liên Chiểu').openPopup();

    const districts = {
      "Liên Chiểu": ["Hòa Khánh Bắc", "Hòa Khánh Nam", "Hòa Hiệp Bắc", "Hòa Hiệp Nam", "Hòa Minh"],
      "Hải Châu": ["Bình Thuận", "Hải Châu I", "Hải Châu II", "Hòa Cường Bắc", "Hòa Cường Nam", "Hòa Thuận Tây", "Phước Ninh", "Thạch Thang", "Thanh Bình", "Thuận Phước"],
      "Sơn Trà": ["Thọ Quang", "Nại Hiên Đông", "Mân Thái", "An Hải Bắc", "An Hải Đông", "An Hải Tây", "Phước Mỹ"],
      "Ngũ Hành Sơn": ["Hòa Hải", "Hòa Quý", "Khuê Mỹ", "Mỹ An"],
      "Cẩm Lệ": ["Hòa An", "Hòa Phát", "Hòa Thọ Đông", "Hòa Thọ Tây", "Hòa Xuân", "Khuê Trung"],
      "Thanh Khê": ["An Khê", "Chính Gián", "Thạc Gián", "Thanh Khê Đông", "Thanh Khê Tây", "Xuân Hà"],
      "Hòa Vang": ["Hòa Bắc", "Hòa Châu", "Hòa Khương", "Hòa Liên", "Hòa Nhơn", "Hòa Ninh", "Hòa Phong", "Hòa Phú", "Hòa Phước", "Hòa Sơn", "Hòa Tiến"],
      "Hoàng Sa": []
    };

    function filterWards() {
      const districtInput = document.getElementById('districtInput').value;
      const wardInput = document.getElementById('wardInput');
      const wardsDatalist = document.getElementById('wards');
      wardsDatalist.innerHTML = '';

      if (districts[districtInput]) {
        districts[districtInput].forEach(ward => {
          const option = document.createElement('option');
          option.value = ward;
          wardsDatalist.appendChild(option);
        });
      }
    }

    document.getElementById('shipping-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const address = document.getElementById('address').value;
      const district = document.getElementById('districtInput').value;
      const ward = document.getElementById('wardInput').value;
      const weight = parseFloat(document.getElementById('weight').value);

      if (address && district && ward && !isNaN(weight) && weight > 0) {
        const fullAddress = `${address}, ${ward}, ${district}, Đà Nẵng, Việt Nam`;
        let destinationCoords = await geocodeAddress(fullAddress);

        if (!destinationCoords) {
          const distanceMap = {
            "Hòa Khánh Bắc": [16.0660, 108.1500], "Hòa Khánh Nam": [16.0598, 108.1482], "Hòa Hiệp Bắc": [16.0700, 108.1400],
            "Hòa Hiệp Nam": [16.0680, 108.1450], "Hòa Minh": [16.0720, 108.1520],
            "Bình Thuận": [16.0600, 108.2200], "Hải Châu I": [16.0650, 108.2250], "Hải Châu II": [16.0670, 108.2300],
            "Hòa Cường Bắc": [16.0630, 108.2200], "Hòa Cường Nam": [16.0610, 108.2180],
            "Hòa Thuận Tây": [16.0640, 108.2200], "Phước Ninh": [16.0660, 108.2300], "Thạch Thang": [16.0680, 108.2350],
            "Thanh Bình": [16.0670, 108.2300], "Thuận Phước": [16.0690, 108.2400],
            "Thọ Quang": [16.1200, 108.2500], "Nại Hiên Đông": [16.1300, 108.2600], "Mân Thái": [16.1400, 108.2700],
            "An Hải Bắc": [16.1300, 108.2500], "An Hải Đông": [16.1400, 108.2600], "An Hải Tây": [16.1500, 108.2700],
            "Phước Mỹ": [16.1400, 108.2600], "Hòa Hải": [16.0500, 108.2400], "Hòa Quý": [16.0400, 108.2300],
            "Khuê Mỹ": [16.0600, 108.2300], "Mỹ An": [16.0500, 108.2200],
            "Hòa An": [16.0700, 108.2100], "Hòa Phát": [16.0600, 108.2000], "Hòa Thọ Đông": [16.0500, 108.1900],
            "Hòa Thọ Tây": [16.0400, 108.1800], "Hòa Xuân": [16.0300, 108.1700], "Khuê Trung": [16.0600, 108.2000],
            "An Khê": [16.0700, 108.2200], "Chính Gián": [16.0800, 108.2300], "Thạc Gián": [16.0900, 108.2400],
            "Thanh Khê Đông": [16.0800, 108.2300], "Thanh Khê Tây": [16.0700, 108.2200], "Xuân Hà": [16.0600, 108.2100],
            "Hòa Bắc": [16.0000, 108.1500], "Hòa Châu": [16.0100, 108.1400], "Hòa Khương": [16.0200, 108.1300],
            "Hòa Liên": [16.0300, 108.1200], "Hòa Nhơn": [16.0400, 108.1100], "Hòa Ninh": [16.0500, 108.1000],
            "Hòa Phong": [16.0600, 108.0900], "Hòa Phú": [16.0700, 108.0800], "Hòa Phước": [16.0800, 108.0700],
            "Hòa Sơn": [16.0900, 108.0600], "Hòa Tiến": [16.1000, 108.0500]
          };
          destinationCoords = distanceMap[ward] || [16.0598, 108.1482]; // Mặc định về Hòa Khánh Nam nếu không tìm thấy
        }

        // Sử dụng API OpenRouteService để tính khoảng cách chính xác
        const apiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjAwOTU5YTdiNjgxZTRiODk4MWQ0NTg0NTkxZjM4ODRlIiwiaCI6Im11cm11cjY0In0=';
        const origin = [16.059212, 108.147189];

        fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
          method: 'POST',
          headers: {
            'Authorization': apiKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            coordinates: [origin.slice().reverse(), destinationCoords.slice().reverse()]
          })
        })
        .then(res => res.json())
        .then(result => {
          const distance = result.features[0].properties.summary.distance / 1000; // Chuyển sang km
          let baseCost = distance * 3000; // Cước cơ bản: 3,000 VNĐ/km
          let additionalCost = 0;
          let packageType;

          if (weight <= 1) {
            packageType = "Nhẹ (0-1kg)";
            additionalCost = 0; // Không thêm phí
          } else if (weight <= 3) {
            packageType = "Trung (1-3kg)";
            additionalCost = (weight - 1) * 3000 * distance; // Thêm 3,000 VNĐ/kg/km từ kg thứ 2
          } else {
            packageType = "Bulky (>3kg)";
            additionalCost = (2 * 3000 * distance) + ((weight - 3) * 800 * distance); // 2kg đầu: 3,000 VNĐ/kg/km, từ kg 4: 800 VNĐ/kg/km
          }

          const totalCost = baseCost + additionalCost;
          const estimatedDays = (distance <= 5) ? 1 : 2;

          document.getElementById('result').innerHTML = `
            <p><strong>Kết quả tính cước:</strong></p>
            <p>Địa chỉ: ${fullAddress}</p>
            <p>Khoảng cách: ${distance.toFixed(2)} km</p>
            <p>Loại gói: ${packageType}</p>
            <p>Cước cơ bản (theo km): ${baseCost.toLocaleString('vi-VN')} VNĐ</p>
            <p>Phí bổ sung (theo trọng lượng): ${additionalCost.toLocaleString('vi-VN')} VNĐ</p>
            <p><strong>Tổng cước: ${totalCost.toLocaleString('vi-VN')} VNĐ</strong></p>
            <p>Thời gian giao hàng dự kiến: ${estimatedDays} ngày</p>
          `;

          map.setView(destinationCoords, 16); // Zoom gần để thấy đường
          pickupMarker.openPopup();
          map.eachLayer(layer => {
            if (layer instanceof L.Marker && layer !== pickupMarker) {
              map.removeLayer(layer);
            }
          });
          L.marker(destinationCoords).addTo(map)
            .bindPopup(`Điểm giao: ${fullAddress}`).openPopup();
        })
        .catch(error => {
          console.error('Error calculating route:', error);
          document.getElementById('result').innerHTML = '<p style="color: #ff5722;">Lỗi khi tính khoảng cách, vui lòng thử lại!</p>';
        });
      } else {
        document.getElementById('result').innerHTML = '<p style="color: #ff5722;">Vui lòng điền đầy đủ thông tin và cân nặng hợp lệ!</p>';
        document.getElementById('map').innerHTML = 'Bản đồ (Placeholder - Sử dụng OpenStreetMap miễn phí)';
      }
    });

    // Hàm geocoding sử dụng Nominatim
    async function geocodeAddress(address) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const data = await response.json();
        if (data && data.length > 0) {
          return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
        }
        return null;
      } catch (error) {
        console.error('Geocoding failed:', error);
        return null;
      }
    }
  </script>
</body>
</html>